@page "/{page}"
@implements IAsyncDisposable
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager _navigationManager
@inject HttpClient _http
@inject IJSRuntime _js

<p>LiveDocs @Page Resource Documentation, last rendered @_lastRendered</p>

<StardustDL.RazorComponents.Markdown.MarkdownRenderer Value="@MarkdownText"
                                                      Class="markdown-body" />

@code {
    private HubConnection _hubConnection;
    public string MarkdownText = "#### waiting for markdown and data to be rendered...";
    private IJSObjectReference _scrollInterface;
    private DateTime _lastRendered = DateTime.Now;

    [Parameter]
    public string Page { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"OnInitializedAsync for {Page}");

        await base.OnInitializedAsync();

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(_navigationManager.ToAbsoluteUri("/latestmarkdownhub"))
            .Build();

        _hubConnection.On<string>("SendLatestMarkdownToInterestedClients", async (newMarkdown) =>
        {
            Console.WriteLine("New markdown received");

            // remember scroll state before updating markdown
            var scrollState = await _scrollInterface.InvokeAsync<System.Drawing.Point>("getScroll");
            Console.WriteLine(scrollState);

            // update markdown
            MarkdownText = newMarkdown;
            _lastRendered = DateTime.Now;
            StateHasChanged();

            // set scroll state to same as before updating markdown
            await _scrollInterface.InvokeVoidAsync("setScroll", scrollState.X, scrollState.Y);
        });

        await _hubConnection.StartAsync();

        await _hubConnection.SendAsync("SelectResource", Page);
        Console.WriteLine($"SelectResource called for {Page}");
    }

    protected override async Task OnParametersSetAsync()
    {
        await _hubConnection.SendAsync("SelectResource", Page);
        Console.WriteLine($"SelectResource called for {Page}");

        await base.OnParametersSetAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _scrollInterface = await _js.InvokeAsync<IJSObjectReference>("import", "./scroll-interface.js");
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_scrollInterface is not null)
        {
            await _scrollInterface.DisposeAsync();
        }
    }
}


